name: Build website

on:
    push:
        branches: master

jobs:
  import-obsidian-notes:
    runs-on: ubuntu-22.04
    
    steps:
      - uses: actions/checkout@v4
        name: Checkout Obsidian vault
        with:
            repository: 'MatusPilnan/Knowledge'
            token: ${{ secrets.GH_PAT }}

      - name: Download Obsidian export
        run: wget -c https://github.com/MatusPilnan/obsidian-export/releases/download/v25.2.0/obsidian-export-x86_64-unknown-linux-gnu.tar.xz -O - | tar -xz

      - name: Create target directory
        run: mkdir -P /data/content

      - name: Run export
        run: ./obsidian-export . /data/content --only-tags publish --remove-tags publish

      - name: Upload exported notes
        uses: actions/upload-artifact@v4
        with:
            name: from-obsidian
            path: /data/content


  build:
    runs-on: ubuntu-22.04
    needs: import-obsidian-notes
    name: Build website
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
            submodules: true

      - name: Download exported Obsidian content
        uses: actions/download-artifact@v4
        with:
            name: from-obsidian
            path: content

      - name: Display structure of downloaded files
        run: ls -al content

      - name: Build site with Hugo
        uses: chabad360/hugo-actions@master
    
      - name: Upload static files as artifact
        id: deployment
        uses: actions/upload-pages-artifact@v3 # or specific "vX.X.X" version tag for this action
        with:
            path: public/

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4